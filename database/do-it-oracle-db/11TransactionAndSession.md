# 트랜잭션 제어와 세션



## 1. 하나의 단위로 데이터를 처리하는 트랜잭션

- 데이터 조작어를 사용해 데이터에 미치는 영향은 트랜잭션과 세션 개념 안에 서 최종적으로 실행 취소 또는 반영이 결정됨.



### 트랜잭션이란?

- 더 이상 분할할 수 없는 최소 수행 단위.
- 어떤 기능 한 가지를 수행하는 SQL문 덩어리.
- 계좌 이체와 같이 하나의 작업 또는 밀접하게 연관된 작업을 수행하기 위해 한 개 이상의 데이터 조작 명령어(DML)로 이루어짐.
- 하나의 트랜잭션 내에 있는 여러 명령어를 한 번에 수행하여 작업을 완료하거나 아예 모두 수행하지 않는 상태, 즉 모든 작업을 취소함.
- ALL OR NOTHING.
- TCL(Transaction Control Language) : 트랜잭션을 제어하기 위해 사용하는 명령어.
- 데이터베이스 접속과 동시에 트랜잭션 시작됨.
- TCL 명령어나 DDL, DCL 명령어를 사용할 때 현재 트랜잭션을 끝내고 새 트랜잭션이 시작됨.



## 2. 트랜잭션을 제어하는 명령어

- TCL은 데이터 조작을 데이터베이스에 영구히 반영하거나 작업 전체를 취소함.



### 트랜잭션을 취소하고 싶을 때는 ROLLBACK

- ROLLBACK은 현재 트랜잭션에 포함된 데이터 조작 관련 명령어의 수행을 모두 취소함.

```
ROLLBACK;
```



### 트랜잭션을 영원히 반영하고 싶을 때는 COMMIT

- 지금까지 수행한 트랜잭션 명령어를 데이터베이스에 영구히 반영할 때 COMMIT(커미트) 명령어 사용함.

```
COMMIT;
```



## 3. 세션과 읽기 일관성의 의미



### 세션이란?

- 세션은 데이터베이스 접속을 시작으로 여러 데이터베이스에서 관련 작업을 수행한 후 접속을 종료하기까지 전체 기간을 의미함.
- 세션이 여러 개라는 말은 현재 오라클 데이터베이스에 접속하여 사용 중인 연결이 여러 개 있다는 뜻.
- 하나의 세션 안에는 여러 개의 트랜잭션이 존재함. 세션이 트랜잭션보다 큰 범위의 개념임.



### 읽기 일관성의 중요성

- 읽기 일관성이란 어떤 특정 세션에서 테이블의 데이터를 변경 중일 때 그 외 다른 세션에서는 데이터의 변경이 확정되기 전까지 변경 사항을 알 필요가 없으므로, 데이터를 변경 중인 세션을 제외한 나머지 세션에서는 현재 진행 중인 변경과 무관한 본래의 데이터를 보여 주는 특성을 의미함.
- 세션 A에서 트랜잭션이 끝나지 않은 DML 명령 결과는 세션 B에서 조회되지 않음. 트랜잭션이 끝나지 않으면 데이터베이스에 반영되지 않기 때문임.
- 어떤 데이터 조작이 포함된 트랜잭션이 완료(COMMIT, ROLLBACK)되기 전까지 데이터를 직접 조작하는 세션 외 다른 세션에서는 데이터 조작 전 상태의 내용이 일관적으로 조회, 출력, 검색되는 특성을 '읽기 일관성(read consistency)'이라고 함.
- 데이터베이스는 DML 명령어 실행 후 ROLLBACK으로 명령어 수행이 취소될 경우에 대비해 변경 전 데이터를 언두 세그먼트(undo segment)에 따로 저장해 둠.
- 데이터를 직접 변경 중인 해당 세션을 제외한 모든 세션은 다른 세션의 데이터 변경과 상관없이 이미 확정된 데이터만 검색됨으로써 읽기 일관성을 보장할 수 있음.



## 4. 수정 중인 데이터 접근을 막는 LOCK



### LOCK란?

- LOCK은 조작 중인 데이터를 다른 세션은 조작할 수 없도록 접근을 보류시키는 것을 뜻함.
- 특정 세션에서 조작 중인 데이터는 트랜잭션이 완료되기 전까지 다른 세션에서 조작할 수 없음.



### LOCK 개념 살펴보기

- 특정 세션에서 데이터 조작이 완료될 때까지 다른 세션에서 해당 데이터 조작을 기다리는 현상을 HANG(행)이라고 함.



### LOCK 종류

- SQL문으로 조작하는 대상 데이터가 테이블의 특정 행 데이터일 경우 해당 행만 LOCK이 발생한다는 의미로 '행 레벨 록(row level lock)'이라고 정의함.
- WHERE절을 지정하지 않은 UPDATE문처럼 테이블의 모든 행 데이터에 영향을 주는 명령어일 경우 테이블에 저장되어 있는 전체 행이 LOCK 상태가 됨.
- 테이블 전체 행이 LOCK 상태여도 INSERT문의 수행은 가능함.
- 테이블에 변경되는 행의 수와는 상관없이 DML 사용하여 데이터가 변경 중인 테이블은 테이블 단위 잠금이라는 의미로 '테이블 레벨 록(table level lock)'이 걸리게 됨. 데이터를 변경 중인 세션 외 다른 세션에서 DDL을 통한 테이블의 구조 변경을 할 수 없음.





